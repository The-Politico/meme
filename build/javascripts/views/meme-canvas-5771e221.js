MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var t=document.createElement("canvas"),e=MEME.$("#meme-canvas");t&&t.getContext?(e.html(t),this.canvas=t,this.setDownload(),this.render()):e.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var t=document.createElement("a");"undefined"==typeof t.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function t(t){var e=l.background.height,a=l.background.width;if(e&&a){var o=e*h.imageScale,i=a*h.imageScale,n=h.backgroundPosition.x||h.width/2,r=h.backgroundPosition.y||h.height/2;t.drawImage(l.background,0,0,a,e,n-i/2,r-o/2,i,o)}}function e(t){return console.log(l.background.height),l.background.height>0?!1:void(h.backgroundColor&&(t.fillStyle=h.backgroundColor,t.fillRect(0,0,h.width,h.height),console.log(h.backgroundColor)))}function a(t){h.overlayColor&&(t.save(),t.globalAlpha=h.overlayAlpha,t.fillStyle=h.overlayColor,t.fillRect(0,0,h.width,h.height),t.globalAlpha=1,t.restore())}function o(t){var e=Math.round(.75*h.width),a=d,o=d;t.font=h.fontSize+"pt "+h.fontFamily,t.fillStyle=h.fontColor,t.textBaseline="top",h.textShadow&&(t.shadowColor="#666",t.shadowOffsetX=-2,t.shadowOffsetY=1,t.shadowBlur=10),"center"==h.textAlign?(t.textAlign="center",a=h.width/2,o=h.height-h.height/1.75,e=h.width-h.width/3):"right"==h.textAlign?(t.textAlign="right",a=h.width-d):t.textAlign="left";for(var i=h.headlineText.split(" "),n="",l=0;l<i.length;l++){var r=n+i[l]+" ",s=t.measureText(r),c=s.width;c>e&&l>0?(t.fillText(n,a,o),n=i[l]+" ",o+=Math.round(1.5*h.fontSize)):n=r}t.fillText(n,a,o),t.shadowColor="transparent"}function i(t){t.textBaseline="bottom",t.textAlign="left",t.fillStyle=h.fontColor,t.font="normal 14pt Arial",t.fillText(h.creditText,d,h.height-d)}function n(t){var e,a,o,i;if(a=i=l.watermark.height,e=o=l.watermark.width,a&&e){var n=h.width*h.watermarkMaxWidthRatio;e>n&&(i=a*(n/e),o=n),t.globalAlpha=h.watermarkAlpha,t.drawImage(l.watermark,0,0,e,a,h.width-d-o,h.height-d-i,o,i),t.globalAlpha=1}}if(this.canvas){var l=this.model,h=this.model.toJSON(),r=this.canvas.getContext("2d"),d=Math.round(h.width*h.paddingRatio);this.canvas.width=h.width,this.canvas.height=h.height,r.clearRect(0,0,h.width,h.height),t(r),e(r),a(r),o(r),i(r),n(r);var s=this.canvas.toDataURL();this.$("#meme-download").attr({href:s,download:(h.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(t){function e(t){t.preventDefault(),a.set("backgroundPosition",{x:Math.max(o.width-i,Math.min(h.x-(l.x-t.clientX),i)),y:Math.max(o.height-n,Math.min(h.y-(l.y-t.clientY),n))})}if(t.preventDefault(),this.model.hasBackground()){var a=this.model,o=a.toJSON(),i=a.background.width*o.imageScale/2,n=a.background.height*o.imageScale/2,l={x:t.clientX,y:t.clientY},h=o.backgroundPosition;h.x=h.x||o.width/2,h.y=h.y||o.height/2;var r=MEME.$(document).on("mousemove.drag",e).on("mouseup.drag",function(t){r.off("mouseup.drag mousemove.drag"),e(t)})}}});